<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="com.test.mj.IRidingDAO">
	
	<!-- 회원가입 -->
	<insert id = "join">
		INSERT INTO MEMBER(USER_ID, ACCESS_ID, JOIN_DATE)
		VALUES(SEQ_MEMBER.NEXTVAL, 1, SYSDATE)
	</insert>
	
	<!-- 개인정보 입력 -->
	<insert id = "profile">
		INSERT INTO PROFILE(PROFILE_ID, USER_ID, MOOD_P_ID, EAT_P_ID, PIMG_ID, DINING_P_ID, SEX_P_ID, AGE_P_ID, EMAIL, BIRTHDAY, SEX, PASSWORD, NICKNAME)
		VALUES(SEQ_PROFILE.NEXTVAL, #{user_id}, #{mood_p_id}, #{eat_p_id}, 1, #{dining_p_id}
		, #{sex_p_id}, #{age_p_id}, #{email}, #{birthday}, #{sex_p_id}, #{password}, #{nickname})
	</insert> 
	
	<!-- 회원가입한 userId 얻어내기 (개인정보 insert용) -->
	<select id="getUser" resultType="java.lang.Integer">
		SELECT MAX(TO_NUMBER(USER_ID))
		FROM MEMBER
	</select>
	
	<!-- 탈퇴 회원 테이블에 정보가 있는지 카운트 하기 -->
	<select id="withdrawCheck" resultType="java.lang.Integer">
		SELECT COUNT(*) AS COUNT
		FROM WITHDRAW_USER W JOIN PROFILE P
		ON W.USER_ID = P.USER_ID
		WHERE P.EMAIL = #{email}
		  AND P.BIRTHDAY = #{birthday}
		  AND TRUNC(MONTHS_BETWEEN(SYSDATE, WITHDRAW_DATE)) <![CDATA[<]]> 3
	</select>
	
	<!-- 닉네임 중복 체크 -->
	<select id="duplicationNickCheck" resultType="java.lang.Integer">
		SELECT COUNT(*)
		FROM PROFILE
		WHERE NICKNAME = #{nickname}
	</select>
	
	<!-- 로그인 -->
	<select id="login" resultType="java.lang.Integer">
		SELECT COUNT(*)
		FROM PROFILE
		WHERE EMAIL = #{email}
		  AND PASSWORD = #{password}
	</select>
	
	<!-- 로그인한 회원의 user_id 알아 내기 -->
	<select id="getUserId" resultType="java.lang.Integer">
		SELECT USER_ID
		FROM PROFILE
		WHERE EMAIL = #{email}
	</select>
	
	<!-- 사이트 이용 제한 여부 알아 내기 -->
	<select id="usageRestrictions" resultType="java.lang.Integer">
		SELECT COUNT(*) AS COUNT
		FROM VIEW_REVIEW_REPORT
		WHERE STATUS = 'APPROVE'
		  AND USER_ID = #{user_id}
		  OR STATUS = 'PUNISH'
		  AND USER_ID = #{user_id}
	</select>

	<!-- 아이디 찾기 -->
	<select id="searchId" resultType="java.lang.String">
		SELECT EMAIL
		FROM PROFILE
		WHERE NICKNAME = #{nickname}
		AND BIRTHDAY = #{birthday}
	</select>
	
	<!-- 비밀번호 찾기 -->
	<select id="searchPassword" resultType="java.lang.String">
		SELECT PASSWORD
		FROM PROFILE
		WHERE EMAIL = #{email}
		  AND BIRTHDAY = #{birthday}
	</select>
	
	<!-- 알림 불러오기 -->
	<select id="noticeList" resultType="java.lang.String">
		SELECT B.CONTENT
		FROM NOTICE A JOIN NOTICE_CONTENT B
		ON A.N_CONTENT_ID = B.N_CONTENT_ID
		WHERE USER_ID=#{user_id}
	</select>
	
	<!-- 알림 개수 -->
	<select id="noticeCount" resultType="java.lang.Integer">
		SELECT COUNT(*) AS COUNT
		FROM NOTICE A JOIN NOTICE_CONTENT B
		ON A.N_CONTENT_ID = B.N_CONTENT_ID
		WHERE USER_ID=#{user_id}
	</select>
	
	<!-- 쪽지 개수 -->
	<select id="messageCount" resultType="java.lang.Integer">
		SELECT COUNT(*) AS COUNT
		FROM MESSAGE
		WHERE RECEIVER_ID=#{user_id}
	</select>
	
	<!-- 참여 가능한 모임 개수 -->
	<select id="openRidingCount" resultType="java.lang.Integer">
		SELECT COUNT(*) AS COUNT
		FROM RIDING
		WHERE START_DATE = TO_DATE(#{today}, 'YYYY-MM-DD')
	</select>
	
	<!-- 완료된 모임 개수 -->
	<select id="closeRidingCount" resultType="java.lang.Integer">
		SELECT COUNT(*) AS COUNT
		FROM RIDING
		WHERE END_DATE = TO_DATE(#{today}, 'YYYY-MM-DD')
	</select>
</mapper>